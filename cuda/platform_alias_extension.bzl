"""Module extension for creating platform-specific aliases for external dependencies.

This extension creates repositories with alias targets that select between x86_64 and ARM64
repositories based on the build platform.
"""

TARGET_MAPPING = {
    "cccl": [
        "cccl_all_files",
        "cccl_header_files",
        "cccl_headers",
        "cub",
        "thrust",
        "valid_toolchain_found",
    ],
    "cudart": [
        "cuda",
        "cuda_lib",
        "cuda_runtime",
        "cuda_runtime_static",
        "cuda_so",
        "cudadevrt_a",
        "cudadevrt_lib",
        "cudart_all_files",
        "cudart_header_files",
        "cudart_headers",
        "cudart_lib",
        "cudart_so",
        "no_cuda_runtime",
        "valid_toolchain_found",
    ],
    "nvcc": [
        "compiler_deps",
        "compiler_root",
        "nvcc_all_files",
        "nvcc_header_files",
        "nvcc_headers",
        "nvptxcompiler",
        "nvptxcompiler_lib",
        "nvptxcompiler_so",
        "valid_toolchain_found",
        "nvcc/bin/nvcc",
        "nvcc/bin/nvlink",
        "nvcc/bin/crt/link.stub",
        "nvcc/bin/bin2c",
        "nvcc/bin/fatbinary",
        "nvvm/bin/cicc",
        ],
    "cublas": [
        "cublas",
        "cublasLt_lib",
        "cublasLt_so",
        "cublas_all_files",
        "cublas_header_files",
        "cublas_headers",
        "cublas_lib",
        "cublas_so",
        "valid_toolchain_found",
    ],
    "cufft": [
        "cufft",
        "cufft_all_files",
        "cufft_header_files",
        "cufft_headers",
        "cufft_lib",
        "cufft_so",
        "cufft_static",
        "cufft_static_a",
        "cufft_static_nocallback",
        "cufft_static_nocallback_a",
        "cufftw_lib",
        "cufftw_so",
        "cufftw_static",
        "cufftw_static_a",
        "valid_toolchain_found",
    ],
    "cusolver": [
        "cusolver",
        "cusolver_all_files",
        "cusolver_header_files",
        "cusolver_headers",
        "cusolver_lib",
        "cusolver_so",
        "valid_toolchain_found",
    ],
    "cusparse": [
        "cusparse",
        "cusparse_all_files",
        "cusparse_header_files",
        "cusparse_headers",
        "cusparse_lib",
        "cusparse_so",
        "valid_toolchain_found",
    ],
    "npp": [
        "npp_all_files",
        "npp_header_files",
        "npp_headers",
        "nppc",
        "nppc_lib",
        "nppc_so",
        "nppi",
        "nppial",
        "nppial_lib",
        "nppial_so",
        "nppicc",
        "nppicc_lib",
        "nppicc_so",
        "nppidei",
        "nppidei_lib",
        "nppidei_so",
        "nppif",
        "nppif_lib",
        "nppif_so",
        "nppig",
        "nppig_lib",
        "nppig_so",
        "nppim",
        "nppim_lib",
        "nppim_so",
        "nppist",
        "nppist_lib",
        "nppist_so",
        "nppisu",
        "nppisu_lib",
        "nppisu_so",
        "nppitc",
        "nppitc_lib",
        "nppitc_so",
        "npps",
        "npps_lib",
        "npps_so",
        "valid_toolchain_found",
    ],
    "nvrtc": [
        "nvrtc",
        "nvrtc_all_files",
        "nvrtc_header_files",
        "nvrtc_headers",
        "nvrtc_lib",
        "nvrtc_so",
        "valid_toolchain_found",
    ],
    "nvjitlink": [
        "nvJitLink",
        "nvJitLink_lib",
        "nvJitLink_so",
        "nvJitLink_static",
        "nvJitLink_static_a",
        "nvjitlink",
        "nvjitlink_all_files",
        "nvjitlink_header_files",
        "nvjitlink_headers",
        "nvjitlink_static",
        "valid_toolchain_found",
    ],
    "nvjpeg": [
        "nvjpeg",
        "nvjpeg_all_files",
        "nvjpeg_header_files",
        "nvjpeg_headers",
        "nvjpeg_lib",
        "nvjpeg_so",
        "nvjpeg_static",
        "nvjpeg_static_a",
        "valid_toolchain_found",
    ],
    "crt": [
        "crt_all_files",
        "crt_header_files",
        "crt_headers",
        "valid_toolchain_found",
    ],
    "nvvm": [
        "nvvm_all_files",
        "nvvm_header_files",
        "nvvm_headers",
        "valid_toolchain_found",
        "nvvm/nvvm/bin/cicc",
        "nvvm/nvvm/libdevice/libdevice.10.bc",
    ],
    "culibos": [
        "culibos_all_files",
        "culibos_license",
        "culibos_a",
    ],
}


def _platform_alias_repo_impl(ctx):
    """Implementation of the platform_alias_repo repository rule.
    
    Args:
        ctx: Repository context with attributes x86_repo, arm64_repo, and targets.
    """
    # Generate BUILD.bazel content with platform-specific aliases
    build_content = ['# Generated by platform_alias_repo rule', '']
    
    # Add load statement for alias
    build_content.append('load("@bazel_skylib//lib:selects.bzl", "selects")')
    build_content.append('')

    # Build a target for the name of the repo
    build_content.append('alias(')
    build_content.append('    name = "{}",'.format(ctx.attr.repo_name))
    build_content.append('    actual = select({')
    build_content.append('        "@rules_cuda//cuda:{}_platform_is_linux_x86_64":'.format("nvcc" if ctx.attr.component_name in ["nvcc", "nvvm"] else "runtime"))
    build_content.append('            ":linux_x86_64_{}",'.format(ctx.attr.repo_name))
    build_content.append('        "@rules_cuda//cuda:{}_platform_is_linux_sbsa":'.format("nvcc" if ctx.attr.component_name in ["nvcc", "nvvm"] else "runtime"))
    build_content.append('            ":linux_sbsa_{}",'.format(ctx.attr.repo_name))
    build_content.append('        "@rules_cuda//cuda:{}_platform_is_linux_aarch64":'.format("nvcc" if ctx.attr.component_name in ["nvcc", "nvvm"] else "runtime"))
    build_content.append('            ":linux_aarch64_{}",'.format(ctx.attr.repo_name)) 
    build_content.append('    }),')
    build_content.append('    visibility = ["//visibility:public"],')
    build_content.append(')')
    build_content.append('')

    build_content.append('alias(')
    build_content.append('    name = "linux_x86_64_{}",'.format(ctx.attr.repo_name))
    build_content.append('    actual = select({')
    for version in ctx.attr.versions:
        build_content.append('        "@rules_cuda//cuda/versions:version_is_{}": '.format(version.replace(".", "_")))
        build_content.append('            "@{}_{}//:{}",'.format(ctx.attr.linux_x86_64_repo, version.replace(".", "_"), ctx.attr.repo_name))
    build_content.append('    }),')
    build_content.append('    visibility = ["//visibility:public"],')
    build_content.append(')')
    build_content.append('')

    for target in TARGET_MAPPING[ctx.attr.component_name]:
        # Create alias for each target with platform selection
        target_name = target if target.find("/") == -1 else target.split("/")[-1]
        build_content.append('alias(')
        build_content.append('    name = "{}",'.format(target_name))
        build_content.append('    actual = select({')
        build_content.append('        "@rules_cuda//cuda:{}_platform_is_linux_x86_64":'.format("nvcc" if ctx.attr.component_name in ["nvcc", "nvvm"] else "runtime"))
        build_content.append('            ":linux_x86_64_{}",'.format(target_name))
        build_content.append('        "@rules_cuda//cuda:{}_platform_is_linux_sbsa":'.format("nvcc" if ctx.attr.component_name in ["nvcc", "nvvm"] else "runtime"))
        build_content.append('            ":linux_sbsa_{}",'.format(target_name))
        build_content.append('        "@rules_cuda//cuda:{}_platform_is_linux_aarch64":'.format("nvcc" if ctx.attr.component_name in ["nvcc", "nvvm"] else "runtime"))
        build_content.append('            ":linux_aarch64_{}",'.format(target_name))
        build_content.append('    }),')
        build_content.append('    visibility = ["//visibility:public"],')
        build_content.append(')')
        build_content.append('')

        build_content.append('alias(')
        build_content.append('    name = "linux_x86_64_{}",'.format(target_name))
        build_content.append('    actual = select({')
        for version in ctx.attr.versions:
            build_content.append('        "@rules_cuda//cuda/versions:version_is_{}": '.format(version.replace(".", "_")))
            build_content.append('            "@{}_{}//{}",'.format(ctx.attr.linux_x86_64_repo, version.replace(".", "_"), target if target.find(":") != -1 else ":" + target))
        build_content.append('    }),')
        build_content.append('    visibility = ["//visibility:public"],')
        build_content.append(')')
        build_content.append('')

    # Write the BUILD.bazel file
    ctx.file("BUILD.bazel", "\n".join(build_content))


platform_alias_repo = repository_rule(
    implementation = _platform_alias_repo_impl,
    attrs = {
        "repo_name": attr.string(
            mandatory = True,
            doc = "Original name of the repository",
        ),
        "component_name": attr.string(
            mandatory = True,
            doc = "Name of the component",
        ),
        "linux_x86_64_repo": attr.string(
            mandatory = True,
            doc = "Name of the repository to use for x86_64 platform",
        ),
        "linux_aarch64_repo": attr.string(
            mandatory = True,
            doc = "Name of the repository to use for ARM64/Jetpack platform",
        ),
        "linux_sbsa_repo": attr.string(
            mandatory = True,
            doc = "Name of the repository to use for SBSA platform",
        ),
        "versions": attr.string_list(
            mandatory = True,
            doc = "List of versions to create aliases for",
        ),
    },
)
